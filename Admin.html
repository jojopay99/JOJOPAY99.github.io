<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>JOJOPAY | 高級管理後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-900 text-white p-4 md:p-8">
    <div id="loginBox" class="max-w-sm mx-auto mt-20 p-6 bg-gray-800 rounded-xl border border-gray-700">
        <h2 class="text-xl mb-4 text-center font-bold text-indigo-400">管理員驗證</h2>
        <input type="password" id="admP" placeholder="請輸入管理密碼" class="w-full p-3 mb-4 bg-gray-700 rounded-lg outline-none">
        <button onclick="adminLogin()" class="w-full bg-indigo-600 py-3 rounded-lg font-bold">進入系統</button>
    </div>

    <div id="adminPanel" class="hidden max-w-5xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-indigo-400">待審核申請名單</h1>
            <button onclick="location.reload()" class="text-xs bg-gray-700 px-3 py-1 rounded">刷新數據</button>
        </div>
        
        <div id="userList" class="space-y-6">
            </div>
    </div>

    <script>
        const conf = { databaseURL: "https://jojopay-cefff-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(conf);
        const db = firebase.database();

        function adminLogin() {
            if(document.getElementById('admP').value === '0895') {
                document.getElementById('loginBox').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                loadUsers();
            } else { alert("密碼錯誤"); }
        }

        function loadUsers() {
            db.ref('users').on('value', (snapshot) => {
                const users = snapshot.val();
                let html = '';
                for(let id in users) {
                    const u = users[id];
                    html += `
                    <div class="bg-gray-800 rounded-2xl p-6 border border-gray-700 shadow-xl">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <p class="text-lg font-bold text-indigo-300 border-b border-gray-700 pb-1">${u.name || '未填'} (${id})</p>
                                <div class="text-sm grid grid-cols-2 gap-2 text-gray-400">
                                    <p>電話: <span class="text-white">${u.phone}</span></p>
                                    <p>職業: <span class="text-white">${u.job}</span></p>
                                    <p class="col-span-2">戶籍: <span class="text-white">${u.hAddr}</span></p>
                                    <p class="col-span-2">現居: <span class="text-white">${u.cAddr}</span></p>
                                    <p>公司: <span class="text-white">${u.compName}</span></p>
                                    <p>公司電話: <span class="text-white">${u.compTel}</span></p>
                                    <p class="col-span-2 text-yellow-500 font-bold">收款銀行: ${u.bank}</p>
                                </div>
                            </div>

                            <div class="bg-black/20 p-4 rounded-xl space-y-4">
                                <div>
                                    <label class="text-xs text-gray-500">設定預估額度 (會顯示在會員中心)</label>
                                    <input type="number" id="limit-${id}" value="${u.loanLimit === '審核中' ? '' : u.loanLimit}" 
                                           placeholder="例如: 50000" class="w-full p-2 bg-gray-700 rounded mt-1 text-green-400 font-bold">
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="updateStatus('${id}', 'approved')" class="flex-1 bg-green-600 py-2 rounded font-bold">核准通過</button>
                                    <button onclick="updateStatus('${id}', 'rejected')" class="flex-1 bg-red-600 py-2 rounded font-bold">拒絕申請</button>
                                </div>
                                <p class="text-center text-xs text-gray-500">當前狀態: <span class="text-indigo-400">${u.status}</span></p>
                            </div>
                        </div>
                        <p class="mt-4 text-xs text-gray-500 italic">註：照片上傳功能因 GitHub 環境限制，後台目前優先讀取文字。如需看圖，請確認 Firebase Storage 已開啟。</p>
                    </div>`;
                }
                document.getElementById('userList').innerHTML = html || '<p class="text-center">目前沒有申請資料</p>';
            });
        }

        function updateStatus(id, status) {
            const limit = document.getElementById('limit-' + id).value;
            if(!limit && status === 'approved') return alert("請先填寫預估額度");
            
            db.ref('users/' + id).update({
                status: status,
                loanLimit: limit || '尚未評估'
            }).then(() => alert("更新成功！使用者已可看到結果。"));
        }
    </script>
</body>
</html>
